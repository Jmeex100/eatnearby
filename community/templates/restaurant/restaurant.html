{% extends 'community_base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% if user.is_authenticated %}
    <!-- Database Stats Overview -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Community Stats</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg">
                <p class="text-sm text-gray-500 dark:text-amber-200">Restaurants</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-white">{{ restaurants.count }}</p>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <p class="text-sm text-gray-500 dark:text-green-200">Active Posts</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-white">{{ recent_posts.count }}</p>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <p class="text-sm text-gray-500 dark:text-blue-200">Recipes</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-white">{{ popular_recipes.count }}</p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <p class="text-sm text-gray-500 dark:text-purple-200">Active Challenges</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-white">{{ active_challenges.count }}</p>
            </div>
        </div>
    </div>
    <!-- Top Customers Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Top Customers</h2>
            <span class="text-amber-600 dark:text-amber-400">Most Active Orderers</span>
        </div>
        <div class="space-y-4">
            {% for customer in top_customers %}
            <div class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700/30 rounded-lg transition-colors">
                <div class="flex-shrink-0">
                    <img class="h-10 w-10 rounded-full" 
                         src="{{ customer.image.url|default:'/static/images/default-profile.png' }}" 
                         alt="{{ customer.username }}">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-800 dark:text-white truncate">
                        {{ customer.username }}
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        {{ customer.order_count }} orders
                    </p>
                </div>
                <div class="flex items-center">
                    {% if forloop.first %}
                    <span class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs font-semibold px-2.5 py-0.5 rounded-full flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        Top
                    </span>
                    {% else %}
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        #{{ forloop.counter }}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4">
                <p class="text-gray-500 dark:text-gray-400">No customer data available yet</p>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-orange-100 to-amber-100 dark:from-orange-900 dark:to-amber-900 rounded-xl p-8 mb-12">
        <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">Welcome to EatNear BY</h1>
        <p class="text-xl text-gray-600 dark:text-amber-100 mb-6 max-w-3xl">
            Your culinary playground to discover restaurants, share experiences, participate in challenges, exchange recipes, and connect with chefs and fellow food lovers.
        </p>
        <div class="flex space-x-4">
            {% if user.is_authenticated %}
                {% if user.user_type == 'customer' %}
                    <a href="{% url 'community:challenge-list' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Join a Challenge</a>
                    <a href="{% url 'community:recipe-list-create' %}" class="border border-amber-600 dark:border-amber-500 text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 px-6 py-3 rounded-lg font-medium transition-colors">Share Your Recipe</a>
                {% elif user.user_type == 'staff' %}
                   
                {% elif user.user_type == 'admin' %}
                    <a href="{% url 'community:restaurant-list' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Manage Restaurants</a>
                    <a href="{% url 'community:challenge-create' %}" class="border border-amber-600 dark:border-amber-500 text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 px-6 py-3 rounded-lg font-medium transition-colors">Create Challenge</a>
                {% endif %}
            {% else %}
                <a href="{% url 'login' %}?next={% url 'community:restaurant' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Sign In to Join</a>
                <a href="{% url 'signup' %}" class="border border-amber-600 dark:border-amber-500 text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 px-6 py-3 rounded-lg font-medium transition-colors">Sign Up</a>
            {% endif %}
        </div>
    </div>
    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">
            <!-- Featured Restaurants -->
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Featured Restaurants</h2>
                    <a href="{% url 'community:restaurant-list' %}" class="text-amber-600 dark:text-amber-400 hover:underline">View All ({{ restaurants.count }})</a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for restaurant in restaurants %}
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="h-48 bg-gray-200 dark:bg-gray-700 relative">
                            {% if restaurant.profile_image %}
                                <img src="{{ restaurant.profile_image.url }}" alt="{{ restaurant.name }}" class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </div>
                            {% endif %}
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                                <h3 class="text-xl font-semibold text-white">{{ restaurant.name }}</h3>
                                <p class="text-sm text-white/80">{{ restaurant.city }}, {{ restaurant.country }}</p>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    {% if restaurant.is_verified %}
                                        <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-2 py-1 rounded-full mr-2">Verified</span>
                                    {% endif %}
                                    <span class="text-sm text-gray-500 dark:text-gray-400">{{ restaurant.created_at|date:"M Y" }}</span>
                                </div>
                                {% if restaurant.website %}
                                    <a href="{{ restaurant.website }}" target="_blank" class="text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                        </svg>
                                    </a>
                                {% endif %}
                            </div>
                            <p class="text-gray-600 dark:text-gray-300 text-sm mb-3 line-clamp-2">{{ restaurant.description|default:"No description provided" }}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                    <span class="font-medium text-gray-700 dark:text-gray-200">
                                        {% if restaurant.average_rating %}
                                            {{ restaurant.average_rating|floatformat:1 }} ({{ restaurant.review_count }} reviews)
                                        {% else %}
                                            No reviews yet
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="{% url 'community:restaurant-detail' restaurant.id %}" class="text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 font-medium text-sm">View Details →</a>
                                    {% if user.is_authenticated and user.user_type == 'admin' %}
                                        <a href="{% url 'community:restaurant-edit' restaurant.id %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium text-sm">Edit</a>
                                        <a href="{% url 'community:restaurant-delete' restaurant.id %}" class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium text-sm">Delete</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            <!-- Recent Community Posts -->
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Recent Community Posts</h2>
                    {% if user.user_type == 'customer' or user.user_type == 'admin' %}
                        <a href="{% url 'community:post-list-create' %}" class="text-amber-600 dark:text-amber-400 hover:underline">View All ({{ recent_posts.count }})</a>
                    {% else %}
                        <span class="text-amber-600 dark:text-amber-400">View All ({{ recent_posts.count }})</span>
                    {% endif %}
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md divide-y divide-gray-100 dark:divide-gray-700">
                    {% for post in recent_posts %}
                        {% if user.user_type != 'staff' or post.restaurant.id == user.restaurant.id %}
                            <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors">
                                <div class="flex items-start space-x-4">
                                    <img class="h-10 w-10 rounded-full" src="{{ post.author.profile.profile_picture.url|default:'/static/images/default-profile.png' }}" alt="{{ post.author.username }}">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ post.author.username }}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ post.created_at|timesince }} ago • {{ post.get_post_type_display }}</p>
                                            </div>
                                            {% if post.restaurant %}
                                                <a href="{% url 'community:restaurant-detail' post.restaurant.id %}" class="text-xs text-amber-600 dark:text-amber-400 hover:underline">{{ post.restaurant.name }}</a>
                                            {% endif %}
                                        </div>
                                        <h4 class="mt-2 text-lg font-semibold text-gray-800 dark:text-white">{{ post.title }}</h4>
                                        <p class="mt-1 text-gray-600 dark:text-gray-300">{{ post.content|truncatechars:200 }}</p>
                                        {% if post.image %}
                                            <div class="mt-3 rounded-lg overflow-hidden max-w-xs">
                                                <img src="{{ post.image.url }}" alt="{{ post.title }}" class="w-full h-auto">
                                            </div>
                                        {% endif %}
                                        <div class="mt-3 flex items-center space-x-4">
                                            <a href="{% url 'community:post-detail' post.id %}" class="flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                                </svg>
                                                {{ post.comments.count }} comments
                                            </a>
                                            <span class="flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 cursor-pointer">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                </svg>
                                                {{ post.likes.count }} likes
                                            </span>
                                            {% if post.review %}
                                                <div class="flex items-center">
                                                    {% for i in "12345" %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 {% if forloop.counter <= post.review.rating %}text-amber-500{% else %}text-gray-300 dark:text-gray-500{% endif %}" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                        </svg>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            {% if user.is_authenticated and user.user_type == 'admin' %}
                                                <a href="{% url 'community:post-edit' post.id %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium text-sm">Edit</a>
                                                <a href="{% url 'community:post-delete' post.id %}" class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium text-sm">Delete</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if user.is_authenticated and user.user_type == 'customer' %}
                    <div class="mt-4">
                        <a href="{% url 'community:post-list-create' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Create Post</a>
                    </div>
                {% endif %}
            </section>
        </div>
        <!-- Right Column -->
        <div class="space-y-8">
            <!-- Active Challenges -->
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Active Challenges</h2>
                    <a href="{% url 'community:challenge-list' %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">View All ({{ active_challenges.count }})</a>
                </div>
                <div class="space-y-4">
                    {% for challenge in active_challenges %}
                        <div class="border border-gray-100 dark:border-gray-700 rounded-lg p-4 hover:border-amber-200 dark:hover:border-amber-600 transition-colors">
                            <div class="h-24 bg-gray-100 dark:bg-gray-700 rounded-lg mb-3 overflow-hidden">
                                {% if challenge.banner_image %}
                                    <img src="{{ challenge.banner_image.url }}" alt="{{ challenge.title }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                            <h3 class="font-semibold text-gray-800 dark:text-white mb-1">{{ challenge.title }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2 line-clamp-2">{{ challenge.description }}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mb-2">
                                <span>{{ challenge.participants.count }} participants</span>
                                <span>Ends in {{ challenge.end_date|timeuntil }}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3">
                                <div class="bg-amber-500 h-2 rounded-full" style="width: {% widthratio challenge.participants.count 100 1 %}%"></div>
                            </div>
                            {% if user.is_authenticated %}
                                {% if user.user_type == 'customer' %}
                                    <a href="{% url 'community:challenge-entry' challenge.id %}" class="block w-full text-center bg-amber-50 dark:bg-amber-900/30 hover:bg-amber-100 dark:hover:bg-amber-900/50 text-amber-700 dark:text-amber-300 py-2 rounded-lg text-sm font-medium">Join Challenge</a>
                                {% elif user.user_type == 'admin' %}
                                    <div class="flex space-x-2">
                                        <a href="{% url 'community:challenge-edit' challenge.id %}" class="block w-full text-center bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 text-blue-700 dark:text-blue-300 py-2 rounded-lg text-sm font-medium">Edit</a>
                                        <a href="{% url 'community:challenge-delete' challenge.id %}" class="block w-full text-center bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 py-2 rounded-lg text-sm font-medium">Delete</a>
                                    </div>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={% url 'community:challenge-entry' challenge.id %}" class="block w-full text-center bg-amber-50 dark:bg-amber-900/30 hover:bg-amber-100 dark:hover:bg-amber-900/50 text-amber-700 dark:text-amber-300 py-2 rounded-lg text-sm font-medium">Sign In to Join</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </section>
            <!-- Popular Recipes -->
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Popular Recipes</h2>
                    <a href="{% url 'community:recipe-list-create' %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">View All ({{ popular_recipes.count }})</a>
                </div>
                <div class="space-y-4">
                    {% for recipe in popular_recipes %}
                        {% if user.user_type != 'staff' or recipe.restaurant.id == user.restaurant.id %}
                            <div class="flex items-center space-x-3 group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/30 p-2 rounded-lg transition-colors">
                                <div class="flex-shrink-0 w-16 h-16 rounded-lg bg-gray-200 dark:bg-gray-700 overflow-hidden">
                                    {% if recipe.image %}
                                        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-medium text-gray-800 dark:text-white group-hover:text-amber-600 dark:group-hover:text-amber-400 truncate">{{ recipe.title }}</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">
                                        {{ recipe.get_difficulty_display }} • {{ recipe.prep_time|add:recipe.cook_time }} mins • {{ recipe.servings }} servings
                                    </p>
                                    <div class="mt-1 flex flex-wrap gap-1">
                                        {% for tag in recipe.tags.all|slice:":2" %}
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">{{ tag.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% if user.is_authenticated and user.user_type == 'admin' %}
                                    <div class="flex space-x-2">
                                        <a href="{% url 'community:recipe-edit' recipe.id %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium text-sm">Edit</a>
                                        <a href="{% url 'community:recipe-delete' recipe.id %}" class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium text-sm">Delete</a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if user.is_authenticated and user.user_type == 'customer' %}
                    <div class="mt-4">
                        <a href="{% url 'community:recipe-list-create' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Share Recipe</a>
                    </div>
                {% endif %}
            </section>
            <!-- Chef Q&A -->
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Chef Q&A</h2>
                    {% if user.is_authenticated %}
                        {% if user.user_type == 'customer' %}
                            <a href="{% url 'community:question-list-create' %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">Ask a Question ({{ recent_questions.count }})</a>
                        {% elif user.user_type == 'staff' and user.restaurant %}
                            <a href="{% url 'community:question-list-create-specific' user.restaurant.id %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">View Questions ({{ recent_questions.count }})</a>
                        {% elif user.user_type == 'admin' %}
                            <a href="{% url 'community:question-list-create' %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">Manage Questions ({{ recent_questions.count }})</a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={% url 'community:restaurant' %}" class="text-amber-600 dark:text-amber-400 hover:underline text-sm">Sign In to Ask ({{ recent_questions.count }})</a>
                    {% endif %}
                </div>
                <div class="space-y-4">
                    {% for question in recent_questions %}
                        {% if user.user_type != 'staff' or question.restaurant.id == user.restaurant.id %}
                            <div class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700/30 rounded-lg transition-colors">
                                <div class="flex items-start space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <p class="text-sm font-medium text-gray-800 dark:text-white">{{ question.user.username }} asked:</p>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ question.created_at|timesince }} ago</span>
                                        </div>
                                        <p class="text-sm text-gray-700 dark:text-gray-300">{{ question.question|truncatechars:100 }}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">To: {{ question.restaurant.name }}</p>
                                    </div>
                                </div>
                                {% if question.is_answered %}
                                    <div class="ml-7 mt-2 pl-3 border-l-2 border-amber-200 dark:border-amber-600">
                                        <div class="flex items-start space-x-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <div>
                                                <div class="flex justify-between items-start">
                                                    <p class="text-sm font-medium text-gray-800 dark:text-white">{{ question.answer.responder.username }} answered:</p>
                                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ question.answer.created_at|timesince }} ago</span>
                                                </div>
                                                <p class="text-sm text-gray-700 dark:text-gray-300">{{ question.answer.answer|truncatechars:100 }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="ml-7 mt-2">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Pending answer</span>
                                        {% if user.is_authenticated and user.user_type == 'staff' and question.restaurant.id == user.restaurant.id %}
                                            <a href="{% url 'community:question-detail' question.id %}" class="text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 font-medium text-sm ml-2">Answer</a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {% if user.is_authenticated and user.user_type == 'admin' %}
                                    <div class="ml-7 mt-2">
                                        <a href="{% url 'community:question-edit' question.id %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium text-sm">Edit</a>
                                        <a href="{% url 'community:question-delete' question.id %}" class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium text-sm ml-2">Delete</a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>
    <!-- Recipe Showcase -->
    <section class="mt-12">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Featured Recipes</h2>
            <a href="{% url 'community:recipe-list-create' %}" class="text-amber-600 dark:text-amber-400 hover:underline">Browse All ({{ featured_recipes.count }})</a>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for recipe in featured_recipes %}
                {% if user.user_type != 'staff' or recipe.restaurant.id == user.restaurant.id %}
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow group">
                        <div class="h-48 bg-gray-200 dark:bg-gray-700 relative">
                            {% if recipe.image %}
                                <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </div>
                            {% endif %}
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors"></div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-lg text-gray-800 dark:text-white group-hover:text-amber-600 dark:group-hover:text-amber-400">{{ recipe.title }}</h3>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if recipe.difficulty == 'EASY' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200{% elif recipe.difficulty == 'MEDIUM' %}bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200{% else %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200{% endif %}">{{ recipe.get_difficulty_display }}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mb-3">
                                <span>{{ recipe.prep_time|add:recipe.cook_time }} mins</span>
                                <span>{{ recipe.servings }} servings</span>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-3">
                                {% for tag in recipe.tags.all|slice:":3" %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500 dark:text-gray-400">By {{ recipe.author.username }}</span>
                                <div class="flex space-x-2">
                                    <a href="{% url 'community:recipe-detail' recipe.id %}" class="text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 font-medium text-sm">View Recipe →</a>
                                    {% if user.is_authenticated and user.user_type == 'admin' %}
                                        <a href="{% url 'community:recipe-edit' recipe.id %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium text-sm">Edit</a>
                                        <a href="{% url 'community:recipe-delete' recipe.id %}" class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium text-sm">Delete</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if user.is_authenticated and user.user_type == 'customer' %}
            <div class="mt-4">
                <a href="{% url 'community:recipe-list-create' %}" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-6 py-3 rounded-lg font-medium transition-colors">Share Recipe</a>
            </div>
        {% endif %}
    </section>
    {% endif %}
</div>

<!-- Chatbot Widget -->
 
<div class="sticky top- right-8 z-[100]">
    <button id="chatbot-toggle" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white p-4 rounded-full shadow-lg transition-all hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>
    <div id="chatbot-window" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-xl w-80 sm:w-96 h-[32rem] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="bg-amber-600 dark:bg-amber-700 text-white p-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-lg font-semibold">EatNear BY Assistant</h3>
            </div>
            <button id="chatbot-close" class="text-white hover:text-amber-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-900 space-y-3">
            <div class="chatbot-message bot-message bg-amber-100 dark:bg-amber-900/30 text-gray-800 dark:text-gray-200 p-3 rounded-lg max-w-[85%]">
                {% if user.is_authenticated %}
                    {% if user.user_type == 'admin' %}
                        Hello, Admin! Ask me about managing restaurants, challenges, or moderating content.
                    {% elif user.user_type == 'customer' %}
                        Hello! I'm your EatNear BY Assistant. Ask me about restaurants, recipes, or challenges!
                    {% elif user.user_type == 'staff' %}
                        Hello, Staff! Ask me about your restaurant's questions, posts, or recipes.
                    {% endif %}
                {% else %}
                    Hello! I'm your EatNear BY Assistant. Sign in to get personalized recommendations!
                {% endif %}
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
            <form id="chatbot-form" class="flex space-x-2">
                {% csrf_token %}
                <input type="text" id="chatbot-input" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Type your question..." autocomplete="off">
                <button type="submit" class="bg-amber-600 hover:bg-amber-700 dark:bg-amber-700 dark:hover:bg-amber-800 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('Chatbot script loaded');
    
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotClose = document.getElementById('chatbot-close');
    const chatbotWindow = document.getElementById('chatbot-window');
    
    if (!chatbotToggle || !chatbotClose || !chatbotWindow) {
        console.error('Could not find chatbot elements');
        return;
    }
    // Toggle chatbot window
    chatbotToggle.addEventListener('click', (e) => {
        e.preventDefault();
        chatbotWindow.classList.toggle('hidden');
        if (!chatbotWindow.classList.contains('hidden')) {
            document.getElementById('chatbot-input')?.focus();
        }
    });
    // Close chatbot window
    chatbotClose.addEventListener('click', (e) => {
        e.preventDefault();
        chatbotWindow.classList.add('hidden');
    });
    // Handle form submission
    const chatbotForm = document.getElementById('chatbot-form');
    if (chatbotForm) {
        chatbotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputField = document.getElementById('chatbot-input');
            const message = inputField?.value.trim();
            
            if (!message) return;
            // Add user message
            addMessage(message, 'user');
            inputField.value = '';
            try {
                // Show thinking indicator (three bouncing dots)
                const thinkingIndicator = addThinkingIndicator();
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    throw new Error('CSRF token not found');
                }
                // Get user type from Django template
                const userType = "{{ request.user.user_type|default:'guest' }}";
                
                // Send request to server
                const response = await fetch('/community/chatbot/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        message: message,
                        user_type: userType
                    }),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Remove thinking indicator
                thinkingIndicator.remove();
                
                // Add bot response with typing effect
                if (data.error) {
                    await typeMessage(`Error: ${data.error}`, 'bot');
                } else {
                    await typeMessage(data.response, 'bot');
                }
            } catch (error) {
                console.error('Chatbot error:', error);
                // Remove any existing indicators
                document.getElementById('typing-indicator')?.remove();
                document.getElementById('thinking-indicator')?.remove();
                await typeMessage(`Sorry, something went wrong. Please try again later.`, 'bot');
            }
        });
    }
    // Helper function to simulate typing
    async function typeMessage(text, sender) {
        const chatbotMessages = document.getElementById('chatbot-messages');
        if (!chatbotMessages) return;
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chatbot-message', 'p-3', 'rounded-lg', 'max-w-[85%]', 'mb-2');
        
        if (sender === 'user') {
            messageDiv.classList.add('ml-auto', 'bg-blue-100', 'dark:bg-blue-900/30', 'text-gray-800', 'dark:text-gray-200');
        } else {
            messageDiv.classList.add('bg-amber-100', 'dark:bg-amber-900/30', 'text-gray-800', 'dark:text-gray-200');
        }
        
        chatbotMessages.appendChild(messageDiv);
        
        // Calculate typing speed based on message length (longer messages type faster)
        const baseSpeed = 30; // ms per character (minimum)
        const lengthFactor = Math.min(text.length / 100, 0.7); // Up to 30% faster for long messages
        const speed = baseSpeed * (1 - lengthFactor);
        
        // Type out the message character by character
        for (let i = 0; i < text.length; i++) {
            messageDiv.textContent = text.substring(0, i + 1);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            
            // Add random variation to typing speed (10-30% faster or slower)
            const randomVariation = 1 + (Math.random() * 0.4 - 0.2); // 0.8 to 1.2 multiplier
            await new Promise(resolve => setTimeout(resolve, speed * randomVariation));
            
            // Occasionally pause between words (10% chance after space)
            if (text[i] === ' ' && Math.random() < 0.1) {
                await new Promise(resolve => setTimeout(resolve, speed * 5)); // Longer pause
            }
        }
    }
    // Add message instantly (for user messages)
    function addMessage(text, sender) {
        const chatbotMessages = document.getElementById('chatbot-messages');
        if (!chatbotMessages) return;
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chatbot-message', 'p-3', 'rounded-lg', 'max-w-[85%]', 'mb-2');
        
        if (sender === 'user') {
            messageDiv.classList.add('ml-auto', 'bg-blue-100', 'dark:bg-blue-900/30', 'text-gray-800', 'dark:text-gray-200');
        } else {
            messageDiv.classList.add('bg-amber-100', 'dark:bg-amber-900/30', 'text-gray-800', 'dark:text-gray-200');
        }
        
        messageDiv.textContent = text;
        chatbotMessages.appendChild(messageDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    // Thinking indicator with animated dots
    function addThinkingIndicator() {
        const chatbotMessages = document.getElementById('chatbot-messages');
        if (!chatbotMessages) return;
        const thinkingDiv = document.createElement('div');
        thinkingDiv.id = 'thinking-indicator';
        thinkingDiv.classList.add('chatbot-message', 'bot-message', 'bg-amber-100', 'dark:bg-amber-900/30', 
                                'p-3', 'rounded-lg', 'max-w-[85%]', 'mb-2', 'flex', 'space-x-1');
        
        // Create three bouncing dots
        for (let i = 0; i < 3; i++) {
            const dot = document.createElement('div');
            dot.classList.add('w-2', 'h-2', 'bg-amber-500', 'rounded-full', 'animate-bounce');
            dot.style.animationDelay = `${i * 0.15}s`;
            thinkingDiv.appendChild(dot);
        }
        
        chatbotMessages.appendChild(thinkingDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        return thinkingDiv;
    }
    // Keyboard shortcut (Ctrl+Shift+C)
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            chatbotWindow.classList.toggle('hidden');
            if (!chatbotWindow.classList.contains('hidden')) {
                document.getElementById('chatbot-input')?.focus();
            }
        }
    });
});
</script>
{% endblock %}